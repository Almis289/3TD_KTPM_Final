@model Book_Store.ViewModels.EmailMarketingViewModel
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Email Marketing";
}

<div class="container mt-4">
    <div class="row">
        <!-- Form gửi email -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4>Gửi Email Marketing</h4>
                </div>
                <div class="card-body">
                    @if (TempData["Message"] != null)
                    {
                        <div class="alert alert-success">@TempData["Message"]</div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    <form asp-action="SendEmailForm" method="post">
                        <div class="mb-3">
                            <label>Tiêu đề email</label>
                            <input asp-for="Subject" class="form-control" id="emailTitle" required />
                        </div>

                        <div class="mb-3">
                            <label>Nội dung</label>
                            <textarea asp-for="Content" class="form-control" rows="5" id="emailContent" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label>Chọn sản phẩm</label>
                            <select asp-for="ProductId" class="form-control" id="productSelect">
                                <option value="">-- Không chọn --</option>
                                @foreach (var p in Model.Products)
                                {
                                    <option value="@p.ProductId" data-image="@p.ImageUrl" data-name="@p.ProductName" data-price="@p.Price" data-description="@p.ProductDetail?.Description">@p.ProductName</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label>Chọn người nhận</label>
                            <select asp-for="SelectedEmails" multiple class="form-control">
                                @foreach (var u in Model.Users)
                                {
                                    <option value="@u.Email">@u.Email</option>
                                }
                            </select>
                            <small class="text-muted">Nếu không chọn sẽ gửi cho tất cả</small>
                        </div>

                        <button type="submit" class="btn btn-success">Gửi email</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Live preview email -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h4>Preview Email</h4>
                </div>
                <div class="card-body" style="background:#f4f4f4;">
                    <div id="previewContainer" style="padding:20px; background:white; border-radius:10px;">
                        <h2 id="previewTitle" style="color:#333;">[Tiêu đề email]</h2>
                        <p id="previewContent" style="font-size:16px; line-height:1.6;">[Nội dung email]</p>
                        <div id="previewProduct" style="margin-top:20px; text-align:center; display:none;">
                            <h3 id="previewProductName"></h3>
                            <p id="previewProductPrice"></p>
                            <p id="previewProductDesc"></p>
                            <img id="previewProductImg" src="" style="max-width:250px; border-radius:10px;" />
                        </div>
                        <hr />
                        <p style="font-size:14px; color:gray;">Cảm ơn bạn đã theo dõi Book Store!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const emailTitle = document.getElementById('emailTitle');
        const emailContent = document.getElementById('emailContent');
        const productSelect = document.getElementById('productSelect');

        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        const previewProduct = document.getElementById('previewProduct');
        const previewProductName = document.getElementById('previewProductName');
        const previewProductPrice = document.getElementById('previewProductPrice');
        const previewProductDesc = document.getElementById('previewProductDesc');
        const previewProductImg = document.getElementById('previewProductImg');

        // Cập nhật tiêu đề và nội dung
        emailTitle.addEventListener('input', () => {
            previewTitle.textContent = emailTitle.value || "[Tiêu đề email]";
        });
        emailContent.addEventListener('input', () => {
            previewContent.innerHTML = (emailContent.value || "[Nội dung email]").replace(/\n/g, "<br>");
        });

        // Cập nhật preview sản phẩm
        productSelect.addEventListener('change', () => {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const imageUrl = selectedOption.getAttribute('data-image');
            const name = selectedOption.getAttribute('data-name');
            const price = selectedOption.getAttribute('data-price');
            const desc = selectedOption.getAttribute('data-description');

            if (imageUrl) {
                previewProductName.textContent = name;
                previewProductPrice.textContent = `Giá: ${parseFloat(price).toLocaleString()}₫`;
                previewProductDesc.textContent = desc || "";
                previewProductImg.src = imageUrl;
                previewProduct.style.display = 'block';
            } else {
                previewProduct.style.display = 'none';
            }
        });
    </script>
}
