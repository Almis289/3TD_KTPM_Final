@model Book_Store.Models.Order
@using Book_Store.Models

@{
    Layout = "_AdminLayout";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Chi tiết đơn hàng #@Model.OrderId</h3>
    <a asp-action="OrderManagement" class="btn btn-outline-secondary btn-sm">← Quay lại</a>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5>Thông tin người đặt</h5>
        <p class="mb-1"><strong>Tên:</strong> @(!string.IsNullOrWhiteSpace(Model.User?.FullName) ? Model.User.FullName : "-")</p>
        <p class="mb-1"><strong>Email:</strong> @(!string.IsNullOrWhiteSpace(Model.User?.Email) ? Model.User.Email : "-")</p>
        <p class="mb-1"><strong>Địa chỉ tài khoản:</strong> @(!string.IsNullOrWhiteSpace(Model.User?.Address) ? Model.User.Address : "-")</p>
        <p class="mb-0"><strong>Điện thoại:</strong> @(!string.IsNullOrWhiteSpace(Model.User?.Phone) ? Model.User.Phone : "-")</p>
    </div>
</div>

<!-- Shipping address (địa chỉ giao hàng) -->
<div class="card mb-3">
    <div class="card-body">
        <h5>Địa chỉ giao hàng</h5>
        <p class="mb-0">
            <strong>Địa chỉ:</strong>
            @(string.IsNullOrWhiteSpace(Model.ShippingAddress) ? "-" : Model.ShippingAddress)
        </p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5>Sản phẩm</h5>
        <table class="table">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Đơn giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in Model.OrderDetails)
                {
                    <tr>
                        <td>@d.Product?.ProductName</td>
                        <td>@(d.UnitPrice.ToString("N0")) ₫</td>
                        <td>@d.Quantity</td>
                        <td>@( (d.UnitPrice * d.Quantity).ToString("N0") ) ₫</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-end">Tổng</th>
                    <th>@Model.TotalAmount.ToString("N0") ₫</th>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5>Thông tin vận chuyển & trạng thái</h5>
        <p class="mb-1"><strong>Ngày đặt:</strong> @Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</p>
        <p class="mb-1"><strong>Trạng thái:</strong> @Model.Status</p>

        @* Hiển thị thông tin thanh toán an toàn *@
        @if (Model.Payments != null && Model.Payments.Any())
        {
            <hr />
            <h6>Thanh toán</h6>
            @foreach (var p in Model.Payments)
            {
                <div class="mb-2">
                    <p class="mb-0">
                        <strong>Phương thức:</strong>
                        @(string.IsNullOrWhiteSpace(p.PaymentMethod) ? "-" : p.PaymentMethod)
                    </p>
                    <p class="mb-0"><strong>Số tiền:</strong> @p.Amount.ToString("N0") ₫</p>
                    <p class="mb-0"><strong>Ngày:</strong> @p.PaymentDate.ToString("dd/MM/yyyy HH:mm")</p>
                    <!-- 👈👈 THÊM HIỂN THỊ MÃ GD 👈👈 -->
                    @if (!string.IsNullOrWhiteSpace(p.TransactionId))
                    {
                        <p class="mb-0 text-success">
                            <strong>Mã giao dịch VNPAY:</strong>
                            <span class="font-monospace">@p.TransactionId</span>
                        </p>
                    }
                </div>
            }
        }
        else
        {
            <div class="alert alert-secondary mt-3">Chưa có thông tin thanh toán.</div>
        }
    </div>
</div>
